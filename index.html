import React, { useState, useEffect } from "react";
import Papa from "papaparse";

const SHEETS = {
  quest: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSLUoaCoGaRwhc7rdFxpQuKmHSdYG5vlzYSjXYSAutTfowLYfmuuKxULAE-ePGl66uZpO7JKk97Yoo7/pub?output=csv",
  items: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSVGd00wRMYJ_keK_ESGV_RUw6yUHUbsexmiXfm9pp8vw_oUGnvYmCKMCNaKwvTNVi8lXED_Qi11edq/pub?output=csv",
  regi: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSnZTHT3SeW7VWywFDBWhvjor0NqrwEcXPyBPOH53FD_Z5GHPNhO4NlGfpzniRjpuJBHna8vZJ1Ndia/pub?output=csv",
  ev: "https://docs.google.com/spreadsheets/d/e/2PACX-1vS3s-al3s9rwdhK0FHls7J368zMl0Hdryc_y6MVwwXaiWLpgzImXs_9YsC5lXkwRdi_aPMi_gRHfsei/pub?output=csv",
};

export default function App() {
  const [data, setData] = useState({});
  const [loading, setLoading] = useState(false);
  const [loaded, setLoaded] = useState(false);
  const [dark, setDark] = useState(false);

  // Quest Helper
  const [region, setRegion] = useState("");
  const [quest, setQuest] = useState("");

  // Item Finder
  const [manual, setManual] = useState("");
  const [regionItem, setRegionItem] = useState("");
  const [locationItem, setLocationItem] = useState("");
  const [item, setItem] = useState("");

  // EV Spot
  const [evRegion, setEvRegion] = useState("");
  const [ev, setEv] = useState("");

  // Regi
  const [time, setTime] = useState("");

  const fetchSheet = (url) =>
    new Promise((resolve) => {
      Papa.parse(url, {
        download: true,
        header: true,
        complete: (res) => resolve(res.data.filter((r) => Object.values(r).some((x) => x))),
      });
    });

  const loadData = async () => {
    setLoading(true);
    const [quest, items, regi, ev] = await Promise.all([
      fetchSheet(SHEETS.quest),
      fetchSheet(SHEETS.items),
      fetchSheet(SHEETS.regi),
      fetchSheet(SHEETS.ev),
    ]);
    setData({ quest, items, regi, ev });
    setLoaded(true);
    setLoading(false);
  };

  // Shoal Cave
  const getShoal = () => {
    const now = new Date();
    const h = now.getUTCHours();
    const m = now.getUTCMinutes();
    const t = h * 60 + m;
    const windows = [
      [0, 180],
      [360, 540],
      [720, 900],
      [1080, 1260],
    ];
    return windows.some(([s, e]) => t >= s && t < e) ? "Lowtide" : "Hightide";
  };

  const unique = (arr) => [...new Set(arr.filter(Boolean))];

  const fuzzy = (hay, needle) => hay.toLowerCase().includes(needle.toLowerCase());

  const Table = ({ rows }) => (
    <table>
      <thead>
        <tr>
          {rows.length > 0 &&
            Object.keys(rows[0]).map((k) => <th key={k}>{k}</th>)}
        </tr>
      </thead>
      <tbody>
        {rows.map((r, i) => (
          <tr key={i}>
            {Object.values(r).map((v, j) => (
              <td key={j} style={{ whiteSpace: "pre-line" }}>
                {v}
              </td>
            ))}
          </tr>
        ))}
      </tbody>
    </table>
  );

  if (!loaded)
    return (
      <div className={dark ? "dark" : ""}>
        <button onClick={loadData} disabled={loading}>
          {loading ? "Loading..." : "Load Data"}
        </button>
        <button onClick={() => setDark(!dark)}>Toggle Dark</button>
        <img
          src="https://i.imgur.com/XZcfQzw.png"
          alt="loading"
          style={{ marginTop: "20px" }}
        />
      </div>
    );

  return (
    <div className={dark ? "dark" : ""}>
      <button onClick={() => setDark(!dark)}>Toggle Dark</button>

      {/* Quest Helper */}
      <section style={{ background: "#FFE8C6", padding: "10px" }}>
        <h2>Quest Helper</h2>
        <select onChange={(e) => setRegion(e.target.value)} value={region}>
          <option value="">Select Region</option>
          {unique(data.quest.map((r) => r.region)).map((r) => (
            <option key={r}>{r}</option>
          ))}
        </select>
        {region && (
          <select onChange={(e) => setQuest(e.target.value)} value={quest}>
            <option value="">Select Quest</option>
            {data.quest
              .filter((r) => r.region === region)
              .map((r, i) => (
                <option key={i}>{r.quest}</option>
              ))}
          </select>
        )}
        {quest && (
          <Table rows={data.quest.filter((r) => r.region === region && r.quest === quest)} />
        )}
      </section>

      {/* Item Finder */}
      <section style={{ padding: "10px" }}>
        <h2>Special Item Finder</h2>
        <input
          value={manual}
          onChange={(e) => setManual(e.target.value)}
          placeholder="Manual search"
        />
        <button>
          Search
        </button>
        {manual &&
          (data.items.filter((r) => fuzzy(r.item || "", manual)).length > 0 ? (
            <Table rows={data.items.filter((r) => fuzzy(r.item || "", manual))} />
          ) : (
            <p>currently not listed</p>
          ))}

        <select onChange={(e) => setRegionItem(e.target.value)} value={regionItem}>
          <option value="">Select Region</option>
          {unique(data.items.map((r) => r.region)).map((r) => (
            <option key={r}>{r}</option>
          ))}
        </select>
        {regionItem && (
          <select onChange={(e) => setLocationItem(e.target.value)} value={locationItem}>
            <option value="">Select Location</option>
            {unique(
              data.items.filter((r) => r.region === regionItem).map((r) => r.location)
            ).map((l) => (
              <option key={l}>{l}</option>
            ))}
          </select>
        )}
        {locationItem && (
          <select onChange={(e) => setItem(e.target.value)} value={item}>
            <option value="">Select Item</option>
            {unique(
              data.items
                .filter((r) => r.region === regionItem && r.location === locationItem)
                .map((r) => r.item)
            ).map((i) => (
              <option key={i}>{i}</option>
            ))}
          </select>
        )}
        {item && (
          <Table
            rows={data.items.filter(
              (r) => r.region === regionItem && r.location === locationItem && r.item === item
            )}
          />
        )}
      </section>

      {/* EV Spot Finder */}
      <section style={{ background: "#FFE8C6", padding: "10px" }}>
        <h2>EV Spot Finder</h2>
        <select onChange={(e) => setEvRegion(e.target.value)} value={evRegion}>
          <option value="">Select Region</option>
          {unique(data.ev.map((r) => r.region)).map((r) => (
            <option key={r}>{r}</option>
          ))}
        </select>
        {evRegion && (
          <select onChange={(e) => setEv(e.target.value)} value={ev}>
            <option value="">Select EV</option>
            {unique(data.ev.filter((r) => r.region === evRegion).map((r) => r.EV)).map((v) => (
              <option key={v}>{v}</option>
            ))}
          </select>
        )}
        {ev && <Table rows={data.ev.filter((r) => r.region === evRegion && r.EV === ev)} />}
      </section>

      {/* Regi Trio */}
      <section style={{ padding: "10px" }}>
        <h2>Regi Trio Check</h2>
        <select onChange={(e) => setTime(e.target.value)} value={time}>
          <option value="">Select Time</option>
          {unique(data.regi.map((r) => r.time)).map((t) => (
            <option key={t}>{t}</option>
          ))}
        </select>
        {time && <Table rows={data.regi.filter((r) => r.time === time)} />}
      </section>

      {/* Shoal Cave */}
      <section style={{ background: "#FFE8C6", padding: "10px" }}>
        <h2>Shoal Cave Check</h2>
        <p>{getShoal()}</p>
      </section>
    </div>
  );
}
