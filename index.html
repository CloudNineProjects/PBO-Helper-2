<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Quest & Tools Helper</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
      background: #f5f5f5;
      color: #222;
    }
    .dark-mode {
      background: #121212;
      color: #eee;
    }
    .container {
      max-width: 1000px;
      margin: auto;
      padding: 20px;
    }
    h2 { margin-top: 30px; }
    select, input, button {
      padding: 6px; margin: 4px;
    }
    table {
      border-collapse: collapse;
      margin-top: 10px;
      width: 100%;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: left;
    }
    .dark-mode table, .dark-mode th, .dark-mode td {
      border: 1px solid #555;
    }
    .section {
      padding: 15px;
      margin-top: 20px;
      border-radius: 8px;
    }
    .highlight { background: #FFE8C6; }
    .dark-mode .highlight { background: #5c4520; }
    #loader {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    #loader img { max-width: 200px; margin-bottom: 20px; }
    #main { display: none; }
  </style>
</head>
<body>
  <div id="loader">
    <img src="https://i.imgur.com/XZcfQzw.png" alt="Loading">
    <button id="loadBtn">Load Data</button>
  </div>

  <div id="main" class="container">
    <button id="darkToggle">Toggle Dark Mode</button>

    <div id="questHelper" class="section highlight">
      <h2>Quest Helper</h2>
      <select id="questRegion"><option value="">Select Region</option></select>
      <select id="questQuest"><option value="">Select Quest</option></select>
      <button onclick="showQuest()">Show</button>
      <div id="questResult"></div>
    </div>

    <div id="specialItem" class="section">
      <h2>Special Item Finder</h2>
      <input type="text" id="itemSearch" placeholder="Enter item name">
      <button onclick="manualItemSearch()">Search</button>
      <br>
      <select id="itemRegion"><option value="">Select Region</option></select>
      <select id="itemLocation"><option value="">Select Location</option></select>
      <select id="itemItem"><option value="">Select Item</option></select>
      <button onclick="filteredItemSearch()">Search</button>
      <div id="itemResult"></div>
    </div>

    <div id="evSpot" class="section highlight">
      <h2>EV Spot Finder</h2>
      <select id="evRegion"><option value="">Select Region</option></select>
      <select id="evValue"><option value="">Select EV</option></select>
      <button onclick="showEV()">Show</button>
      <div id="evResult"></div>
    </div>

    <div id="regiCheck" class="section">
      <h2>Regi Trio Check</h2>
      <select id="regiTime"><option value="">Select Time</option></select>
      <div id="regiResult"></div>
    </div>

    <div id="shoalCave" class="section highlight">
      <h2>Shoal Cave Check</h2>
      <button onclick="checkShoal()">Check Tide</button>
      <div id="shoalResult"></div>
    </div>
  </div>

<script>
let questData=[], itemData=[], evData=[], regiData=[];

const questUrl="https://docs.google.com/spreadsheets/d/e/2PACX-1vSLUoaCoGaRwhc7rdFxpQuKmHSdYG5vlzYSjXYSAutTfowLYfmuuKxULAE-ePGl66uZpO7JKk97Yoo7/pub?output=csv";
const itemUrl="https://docs.google.com/spreadsheets/d/e/2PACX-1vSVGd00wRMYJ_keK_ESGV_RUw6yUHUbsexmiXfm9pp8vw_oUGnvYmCKMCNaKwvTNVi8lXED_Qi11edq/pub?output=csv";
const evUrl="https://docs.google.com/spreadsheets/d/e/2PACX-1vS3s-al3s9rwdhK0FHls7J368zMl0Hdryc_y6MVwwXaiWLpgzImXs_9YsC5lXkwRdi_aPMi_gRHfsei/pub?output=csv";
const regiUrl="https://docs.google.com/spreadsheets/d/e/2PACX-1vSnZTHT3SeW7VWywFDBWhvjor0NqrwEcXPyBPOH53FD_Z5GHPNhO4NlGfpzniRjpuJBHna8vZJ1Ndia/pub?output=csv";

document.getElementById("loadBtn").onclick=()=>{
  document.getElementById("loadBtn").innerText="Loading...";
  Promise.all([
    fetchCSV(questUrl).then(d=>questData=d),
    fetchCSV(itemUrl).then(d=>itemData=d),
    fetchCSV(evUrl).then(d=>evData=d),
    fetchCSV(regiUrl).then(d=>regiData=d)
  ]).then(()=>{
    setupQuest();
    setupItem();
    setupEV();
    setupRegi();
    document.getElementById("loader").style.display="none";
    document.getElementById("main").style.display="block";
  });
};

function fetchCSV(url){
  return new Promise(res=>{
    Papa.parse(url,{download:true,header:true,complete:r=>res(r.data.filter(x=>Object.values(x).some(v=>v)))});
  });
}

// Quest Helper
function setupQuest(){
  let regions=[...new Set(questData.map(r=>r.Region).filter(Boolean))];
  let sel=document.getElementById("questRegion");
  regions.forEach(r=>sel.add(new Option(r,r)));
  sel.onchange=()=>{
    let qs=questData.filter(x=>x.Region===sel.value).map(x=>x.Quest);
    let uniq=[...new Set(qs)];
    let qSel=document.getElementById("questQuest");
    qSel.innerHTML="<option value=''>Select Quest</option>";
    uniq.forEach(q=>qSel.add(new Option(q,q)));
  };
}
function showQuest(){
  let r=document.getElementById("questRegion").value;
  let q=document.getElementById("questQuest").value;
  let row=questData.find(x=>x.Region===r&&x.Quest===q);
  if(row){
    document.getElementById("questResult").innerHTML=makeTable([row]);
  }
}

// Item Finder
function setupItem(){
  let regions=[...new Set(itemData.map(r=>r.region).filter(Boolean))];
  let sel=document.getElementById("itemRegion");
  regions.forEach(r=>sel.add(new Option(r,r)));
  sel.onchange=()=>{
    let locs=[...new Set(itemData.filter(x=>x.region===sel.value).map(x=>x.location))];
    let lSel=document.getElementById("itemLocation");
    lSel.innerHTML="<option value=''>Select Location</option>";
    locs.forEach(l=>lSel.add(new Option(l,l)));
  };
  document.getElementById("itemLocation").onchange=()=>{
    let reg=document.getElementById("itemRegion").value;
    let loc=document.getElementById("itemLocation").value;
    let items=[...new Set(itemData.filter(x=>x.region===reg&&x.location===loc).map(x=>x.item))];
    let iSel=document.getElementById("itemItem");
    iSel.innerHTML="<option value=''>Select Item</option>";
    items.forEach(i=>iSel.add(new Option(i,i)));
  };
}
function manualItemSearch(){
  let term=document.getElementById("itemSearch").value.toLowerCase();
  let rows=itemData.filter(r=>r.item.toLowerCase().includes(term));
  document.getElementById("itemResult").innerHTML=rows.length?makeTable(rows):"currently not listed";
}
function filteredItemSearch(){
  let reg=document.getElementById("itemRegion").value;
  let loc=document.getElementById("itemLocation").value;
  let itm=document.getElementById("itemItem").value;
  let rows=itemData.filter(r=>r.region===reg&&r.location===loc&&r.item===itm);
  document.getElementById("itemResult").innerHTML=rows.length?makeTable(rows):"currently not listed";
}

// EV Spot Finder
function setupEV(){
  let regions=[...new Set(evData.map(r=>r.region).filter(Boolean))];
  let sel=document.getElementById("evRegion");
  regions.forEach(r=>sel.add(new Option(r,r)));
  sel.onchange=()=>{
    let evs=[...new Set(evData.filter(x=>x.region===sel.value).map(x=>x.EV))];
    let eSel=document.getElementById("evValue");
    eSel.innerHTML="<option value=''>Select EV</option>";
    evs.forEach(e=>eSel.add(new Option(e,e)));
  };
}
function showEV(){
  let r=document.getElementById("evRegion").value;
  let ev=document.getElementById("evValue").value;
  let rows=evData.filter(x=>x.region===r&&x.EV===ev);
  document.getElementById("evResult").innerHTML=makeTable(rows);
}

// Regi Trio
function setupRegi(){
  let times=[...new Set(regiData.map(r=>r.time).filter(Boolean))];
  let sel=document.getElementById("regiTime");
  times.forEach(t=>sel.add(new Option(t,t)));
  sel.onchange=()=>{
    let rows=regiData.filter(x=>x.time===sel.value);
    document.getElementById("regiResult").innerHTML=makeTable(rows);
  };
}

// Shoal Cave
function checkShoal(){
  let now=new Date();
  let utcH=now.getUTCHours(), utcM=now.getUTCMinutes();
  let minutes=utcH*60+utcM;
  let low=[[0,180],[360,540],[720,900],[1080,1260]];
  let isLow=low.some(([s,e])=>minutes>=s&&minutes<e);
  document.getElementById("shoalResult").innerText=isLow?"Lowtide":"Hightide";
}

// Helpers
function makeTable(rows){
  if(!rows.length) return "No results";
  let headers=Object.keys(rows[0]);
  let html="<table><tr>"+headers.map(h=>"<th>"+h+"</th>").join("")+"</tr>";
  rows.forEach(r=>{
    html+="<tr>"+headers.map(h=>"<td>"+(r[h]||"")+"</td>").join("")+"</tr>";
  });
  return html+"</table>";
}

document.getElementById("darkToggle").onclick=()=>document.body.classList.toggle("dark-mode");
</script>
</body>
</html>
