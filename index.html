<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PBO Quest & Items Helper</title>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --accent:#0b74de;
      --highlight:#FFE8C6;
      --bg:#ffffff;
      --text:#0b1720;
      --card-radius:10px;
    }
    body{font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;margin:0;background:var(--bg);color:var(--text)}
    header{display:flex;justify-content:flex-end;padding:12px}
    .container{max-width:1100px;margin:0 auto;padding:12px}
    button{background:var(--accent);color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    button.secondary{background:#eef3fb;color:var(--text)}
    h1{margin:0 0 12px 0;font-size:1.25rem}
    .loading-screen{height:100vh;display:flex;align-items:center;justify-content:center}
    .loader-inner{text-align:center}
    .loader-inner img{max-width:220px;margin-bottom:12px;display:block;margin-left:auto;margin-right:auto}
    .card{border-radius:var(--card-radius);padding:14px;margin:14px 0;box-shadow:0 6px 18px rgba(10,20,40,0.06);border:1px solid rgba(10,20,40,0.04);background:#fff}
    .card.highlight{background:var(--highlight)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:12px}
    select,input[type="text"]{padding:8px;border-radius:8px;border:1px solid #e6eef9;width:100%;max-width:420px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border-bottom:1px solid #eef3fb;text-align:left;vertical-align:top}
    pre.content{white-space:pre-wrap;font-family:inherit;margin:0}
    .muted{color:#6b7280}
    .hidden{display:none}
    .dark-mode{--bg:#0b0b0b;--text:#e6eef9;background:#0b0b0b;color:#e6eef9}
    .dark-mode .card{box-shadow:none;border:1px solid rgba(255,255,255,0.04);background:#0f1113}
    .dark-mode .card.highlight{background:#5a4636}
    .dark-mode select,input[type="text"]{background:#111214;color:#e6eef9;border:1px solid rgba(255,255,255,0.06)}
    .dark-mode th,.dark-mode td{border-bottom:1px solid rgba(255,255,255,0.06);color:var(--text)}
    .dark-mode button{background:#1f2937;color:var(--text)}
    .dark-mode button.secondary{background:#0b1220;color:var(--text);border:1px solid rgba(255,255,255,0.06)}
  </style>
</head>
<body>
  <header>
    <button id="darkToggle" class="secondary">ðŸŒ™ Dark Mode</button>
  </header>

  <main class="container">
    <!-- Loading -->
    <div id="loading" class="loading-screen">
      <div class="loader-inner">
        <img src="https://i.imgur.com/XZcfQzw.png" alt="Logo">
        <div style="margin-top:8px">
          <button id="loadBtn">Load Data</button>
        </div>
        <div id="loadStatus" class="muted" style="margin-top:10px"></div>
      </div>
    </div>

    <!-- App -->
    <div id="app" class="hidden">
      <h1>PBO Quest & Items Helper</h1>

      <!-- Quest Helper -->
      <div class="card highlight">
        <h2>Quest Helper</h2>
        <div class="row">
          <select id="questRegion"></select>
          <select id="questName"></select>
          <button id="questShow">Show</button>
        </div>
        <div id="questResult"></div>
      </div>

      <!-- Special Item Finder -->
      <div class="card">
        <h2>Special Item Finder</h2>
        <div class="row">
          <input type="text" id="itemSearch" placeholder="Search item manually"/>
          <button id="itemSearchBtn">Search</button>
        </div>
        <div class="row">
          <select id="itemRegion"></select>
          <select id="itemLocation"></select>
          <select id="itemName"></select>
          <button id="itemFilterBtn">Search</button>
        </div>
        <div id="itemResult"></div>
      </div>

      <!-- EV Spot Finder -->
      <div class="card highlight">
        <h2>EV Spot Finder</h2>
        <div class="row">
          <select id="evRegion"></select>
          <select id="evStat"></select>
          <button id="evShow">Show</button>
        </div>
        <div id="evResult"></div>
      </div>

      <!-- Regi Trio Check -->
      <div class="card">
        <h2>Regi Trio Check</h2>
        <div class="row">
          <select id="regiTime"></select>
        </div>
        <div id="regiResult"></div>
      </div>

      <!-- Shoal Cave Check -->
      <div class="card highlight">
        <h2>Shoal Cave Check</h2>
        <div id="shoalResult"></div>
      </div>
    </div>
  </main>

<script>
  // Sheet URLs
  const urls = {
    quest:"https://docs.google.com/spreadsheets/d/e/2PACX-1vSLUoaCoGaRwhc7rdFxpQuKmHSdYG5vlzYSjXYSAutTfowLYfmuuKxULAE-ePGl66uZpO7JKk97Yoo7/pub?output=csv",
    items:"https://docs.google.com/spreadsheets/d/e/2PACX-1vSVGd00wRMYJ_keK_ESGV_RUw6yUHUbsexmiXfm9pp8vw_oUGnvYmCKMCNaKwvTNVi8lXED_Qi11edq/pub?output=csv",
    ev:"https://docs.google.com/spreadsheets/d/e/2PACX-1vS3s-al3s9rwdhK0FHls7J368zMl0Hdryc_y6MVwwXaiWLpgzImXs_9YsC5lXkwRdi_aPMi_gRHfsei/pub?output=csv",
    regi:"https://docs.google.com/spreadsheets/d/e/2PACX-1vSnZTHT3SeW7VWywFDBWhvjor0NqrwEcXPyBPOH53FD_Z5GHPNhO4NlGfpzniRjpuJBHna8vZJ1Ndia/pub?output=csv"
  };

  let questData=[], itemData=[], evData=[], regiData=[];

  function loadCSV(url){ return new Promise((res,rej)=>Papa.parse(url,{download:true,header:true,complete:r=>res(r.data),error:rej})) }

  async function loadData(){
    document.getElementById("loadStatus").innerText="Loading data...";
    [questData,itemData,evData,regiData]=await Promise.all([loadCSV(urls.quest),loadCSV(urls.items),loadCSV(urls.ev),loadCSV(urls.regi)]);
    document.getElementById("loading").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    initQuest();initItems();initEV();initRegi();initShoal();
  }

  // Quest
  function initQuest(){
    const regionSel=document.getElementById("questRegion");
    const questSel=document.getElementById("questName");
    regionSel.innerHTML='<option value="">Select Region</option>';
    [...new Set(questData.map(r=>r.Region).filter(x=>x))].forEach(r=>{
      let o=document.createElement("option");o.value=o.textContent=r;regionSel.appendChild(o);
    });
    regionSel.onchange=()=>{
      questSel.innerHTML="";
      questData.filter(r=>r.Region===regionSel.value).forEach(q=>{
        let o=document.createElement("option");o.value=o.textContent=q.Quest;questSel.appendChild(o);
      });
    };
    document.getElementById("questShow").onclick=()=>{
      const r=questData.find(q=>q.Region===regionSel.value && q.Quest===questSel.value);
      if(!r)return;
      document.getElementById("questResult").innerHTML=`
        <table><tr><th>Region</th><th>Quest</th><th>Content</th></tr>
        <tr><td>${r.Region}</td><td>${r.Quest}</td><td><pre class="content">${r.Content}</pre></td></tr></table>`;
    };
  }

  // Items
  function initItems(){
    const regSel=document.getElementById("itemRegion");
    const locSel=document.getElementById("itemLocation");
    const itemSel=document.getElementById("itemName");
    regSel.innerHTML='<option value="">Select Region</option>';
    [...new Set(itemData.map(r=>r.region).filter(x=>x))].forEach(r=>{
      let o=document.createElement("option");o.value=o.textContent=r;regSel.appendChild(o);
    });
    regSel.onchange=()=>{
      locSel.innerHTML="";itemSel.innerHTML="";
      [...new Set(itemData.filter(r=>r.region===regSel.value).map(r=>r.location))].forEach(l=>{
        let o=document.createElement("option");o.value=o.textContent=l;locSel.appendChild(o);
      });
    };
    locSel.onchange=()=>{
      itemSel.innerHTML="";
      [...new Set(itemData.filter(r=>r.region===regSel.value && r.location===locSel.value).map(r=>r.item))].forEach(i=>{
        let o=document.createElement("option");o.value=o.textContent=i;itemSel.appendChild(o);
      });
    };
    document.getElementById("itemSearchBtn").onclick=()=>{
      let q=document.getElementById("itemSearch").value.toLowerCase();
      let row=itemData.find(r=>(r.item||"").toLowerCase().includes(q));
      document.getElementById("itemResult").innerHTML=row?tableRow(row):"<p>currently not listed</p>";
    };
    document.getElementById("itemFilterBtn").onclick=()=>{
      let row=itemData.find(r=>r.region===regSel.value&&r.location===locSel.value&&r.item===itemSel.value);
      document.getElementById("itemResult").innerHTML=row?tableRow(row):"";
    };
  }

  // EV
  function initEV(){
    const regSel=document.getElementById("evRegion");
    const statSel=document.getElementById("evStat");
    regSel.innerHTML='<option value="">Select Region</option>';
    [...new Set(evData.map(r=>r.region).filter(x=>x))].forEach(r=>{
      let o=document.createElement("option");o.value=o.textContent=r;regSel.appendChild(o);
    });
    regSel.onchange=()=>{
      statSel.innerHTML="";
      [...new Set(evData.filter(r=>r.region===regSel.value).map(r=>r.EV))].forEach(s=>{
        let o=document.createElement("option");o.value=o.textContent=s;statSel.appendChild(o);
      });
    };
    document.getElementById("evShow").onclick=()=>{
      const rows=evData.filter(r=>r.region===regSel.value&&r.EV===statSel.value);
      if(!rows.length)return;
      document.getElementById("evResult").innerHTML=tableRows(rows);
    };
  }

  // Regi
  function initRegi(){
    const sel=document.getElementById("regiTime");
    sel.innerHTML='<option value="">Select Time</option>';
    [...new Set(regiData.map(r=>r.time).filter(x=>x))].forEach(t=>{
      let o=document.createElement("option");o.value=o.textContent=t;sel.appendChild(o);
    });
    sel.onchange=()=>{
      const row=regiData.find(r=>r.time===sel.value);
      document.getElementById("regiResult").innerHTML=row?tableRow(row):"";
    };
  }

  // Shoal
  function initShoal(){
    function check(){
      const now=new Date();
      const utcH=now.getUTCHours(),utcM=now.getUTCMinutes();
      const mins=utcH*60+utcM;
      function inRange(start,end){
        const [sh,sm]=start.split(":").map(Number),[eh,em]=end.split(":").map(Number);
        return mins>=sh*60+sm && mins<eh*60+em;
      }
      const low=[["00:00","03:00"],["06:00","09:00"],["12:00","15:00"],["18:00","21:00"]];
      const lowtide=low.some(([s,e])=>inRange(s,e));
      document.getElementById("shoalResult").innerText=lowtide?"Lowtide":"Hightide";
    }
    check();setInterval(check,60000);
  }

  function tableRow(row){ 
    let keys=Object.keys(row); 
    return `<table><tr>${keys.map(k=>`<th>${k}</th>`).join("")}</tr>
            <tr>${keys.map(k=>`<td>${row[k]}</td>`).join("")}</tr></table>`; 
  }
  function tableRows(rows){ 
    let keys=Object.keys(rows[0]); 
    return `<table><tr>${keys.map(k=>`<th>${k}</th>`).join("")}</tr>
      ${rows.map(r=>`<tr>${keys.map(k=>`<td>${r[k]}</td>`).join("")}</tr>`).join("")}</table>`;
  }

  // Events
  document.getElementById("loadBtn").onclick=loadData;
  document.getElementById("darkToggle").onclick=()=>document.body.classList.toggle("dark-mode");
</script>
</body>
</html>
